<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Call</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .video-container {
            background-color: #333;
            border-radius: 8px;
            overflow: hidden;
        }
        video {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }
        .controls {
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #roomId {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .local-video {
            border: 2px solid #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <input type="text" id="roomId" placeholder="Enter room ID">
            <button onclick="joinRoom()">Join Room</button>
            <button onclick="toggleVideo()">Toggle Video</button>
            <button onclick="toggleAudio()">Toggle Audio</button>
        </div>
        <div class="video-grid" id="videoGrid">
            <div class="video-container">
                <video id="localVideo" class="local-video" autoplay playsinline muted></video>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const videoGrid = document.getElementById('videoGrid');
        const localVideo = document.getElementById('localVideo');
        let localStream;
        const peers = new Map(); // Store RTCPeerConnection objects

        // Get local media stream
        async function setupLocalStream() {
            try {
                console.log('Requesting media devices...');
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });
                console.log('Got local stream:', localStream.getTracks().map(t => `${t.kind}: ${t.enabled}`));
                localVideo.srcObject = localStream;
                localVideo.onloadedmetadata = () => {
                    console.log('Local video metadata loaded');
                    localVideo.play().catch(e => console.error('Error playing local video:', e));
                };
            } catch (err) {
                console.error('Error accessing media devices:', err);
                alert('Error accessing camera/microphone. Please ensure you have granted permissions.');
            }
        }

        // Initialize when page loads
        setupLocalStream();

        async function joinRoom() {
            const roomId = document.getElementById('roomId').value;
            if (!roomId) return alert('Please enter a room ID');
            
            socket.emit('join-room', roomId);
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
            }
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
            }
        }

        // Create a new peer connection
        async function createPeerConnection(userId) {
            const peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            });

            // Add local stream
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Create video element for remote stream
            const remoteVideo = document.createElement('video');
            remoteVideo.id = `remote-${userId}`;
            remoteVideo.autoplay = true;
            remoteVideo.playsinline = true;
            
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-container';
            videoContainer.appendChild(remoteVideo);
            videoGrid.appendChild(videoContainer);

            // Handle remote stream
            peerConnection.ontrack = (event) => {
                console.log('Received remote track:', event.track.kind);
                remoteVideo.srcObject = event.streams[0];
                remoteVideo.onloadedmetadata = () => {
                    console.log('Remote video metadata loaded');
                    remoteVideo.play().catch(e => console.error('Error playing remote video:', e));
                };
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        target: userId,
                        candidate: event.candidate
                    });
                }
            };

            // Log connection state changes
            peerConnection.onconnectionstatechange = () => {
                console.log(`Connection state with ${userId}:`, peerConnection.connectionState);
            };
            
            peerConnection.oniceconnectionstatechange = () => {
                console.log(`ICE connection state with ${userId}:`, peerConnection.iceConnectionState);
            };

            peers.set(userId, peerConnection);
            return peerConnection;
        }

        // Socket event handlers
        socket.on('user-connected', async (userId) => {
            console.log('User connected:', userId);
            if (!localStream) {
                console.log('Waiting for local stream...');
                await setupLocalStream();
            }
            const peerConnection = await createPeerConnection(userId);
            
            // Create and send offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('offer', {
                target: userId,
                offer: offer
            });
        });

        socket.on('offer', async ({ from, offer }) => {
            console.log('Received offer from:', from);
            const peerConnection = await createPeerConnection(from);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            
            // Create and send answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', {
                target: from,
                answer: answer
            });
        });

        socket.on('answer', async ({ from, answer }) => {
            console.log('Received answer from:', from);
            const peerConnection = peers.get(from);
            if (peerConnection) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            }
        });

        socket.on('ice-candidate', async ({ from, candidate }) => {
            console.log('Received ICE candidate from:', from);
            const peerConnection = peers.get(from);
            if (peerConnection) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        });

        socket.on('user-disconnected', (userId) => {
            console.log('User disconnected:', userId);
            const peerConnection = peers.get(userId);
            if (peerConnection) {
                peerConnection.close();
                peers.delete(userId);
            }
            const remoteVideo = document.getElementById(`remote-${userId}`);
            if (remoteVideo) {
                remoteVideo.parentElement.remove();
            }
        });
    </script>
</body>
</html>
