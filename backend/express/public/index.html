<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Call</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .video-container {
            background-color: #333;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        video {
            width: 100%;
            height: 300px;
            object-fit: cover;
            cursor: pointer;
        }
        .controls {
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-area {
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 10px 20px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #roomId {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .local-video {
            border: 2px solid #007bff;
        }
        .room-info {
            font-size: 16px;
            color: #007bff;
            margin-bottom: 10px;
        }
        .participants-list {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <input type="text" id="roomId" placeholder="Enter room ID">
            <button onclick="startCall()">Start Call</button>
            <button onclick="toggleVideo()">Toggle Video</button>
            <button onclick="toggleAudio()">Toggle Audio</button>
        </div>
        <div class="status-area" id="statusArea">
            <div class="room-info" id="roomInfo">Not in a room</div>
            <div class="participants-list" id="participantsList"></div>
        </div>
        <div class="video-grid" id="videoGrid">
            <div class="video-container">
                <video id="localVideo" class="local-video" autoplay playsinline muted></video>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const videoGrid = document.getElementById('videoGrid');
        const localVideo = document.getElementById('localVideo');
        const roomInfo = document.getElementById('roomInfo');
        const participantsList = document.getElementById('participantsList');
        let localStream;
        const peers = new Map();
        let currentRoom = null;
        let participants = new Set();

        function updateRoomStatus() {
            if (currentRoom) {
                roomInfo.textContent = `Currently in Room: ${currentRoom}`;
                participantsList.textContent = `Participants (${participants.size + 1}): You${Array.from(participants).map(p => ', ' + p).join('')}`;
            } else {
                roomInfo.textContent = 'Not in a room';
                participantsList.textContent = '';
            }
        }

        // Initialize camera when user clicks "Start Call"
        async function startCall() {
            const roomId = document.getElementById('roomId').value;
            if (!roomId) return alert('Please enter a room ID');
            
            try {
                // Get user media if we haven't already
                if (!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: false,  // Start with video off
                        audio: true
                    });
                    localVideo.srcObject = localStream;
                    
                    // Add a dummy video track that's disabled
                    const dummyStream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const videoTrack = dummyStream.getVideoTracks()[0];
                    videoTrack.enabled = false;  // Start disabled
                    localStream.addTrack(videoTrack);
                    
                    // Play the stream (should work since it's just audio initially)
                    await localVideo.play();
                }

                // Join the room
                currentRoom = roomId;
                socket.emit('join-room', roomId);
            } catch (err) {
                console.error('Error starting call:', err);
                alert('Could not access camera/microphone. Please ensure you have granted permissions.');
            }
        }

        async function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (!videoTrack || !videoTrack.enabled) {
                    // If no video track or it's disabled, create new one
                    try {
                        const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                        const newVideoTrack = videoStream.getVideoTracks()[0];
                        
                        // Remove old track if it exists
                        const oldTrack = localStream.getVideoTracks()[0];
                        if (oldTrack) {
                            localStream.removeTrack(oldTrack);
                            oldTrack.stop();
                        }
                        
                        // Add new track
                        localStream.addTrack(newVideoTrack);
                        console.log('Video enabled');
                    } catch (err) {
                        console.error('Error enabling video:', err);
                        alert('Could not access camera. Please check permissions.');
                    }
                } else {
                    // If video is enabled, disable it
                    videoTrack.enabled = false;
                    videoTrack.stop();
                    console.log('Video disabled');
                }
            }
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
            }
        }

        // Create a new peer connection
        async function createPeerConnection(userId) {
            const peerConnection = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            });

            // Add local stream
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });

            // Create video container and element for remote stream
            const videoContainer = document.createElement('div');
            videoContainer.className = 'video-container';
            
            const remoteVideo = document.createElement('video');
            remoteVideo.id = `remote-${userId}`;
            remoteVideo.autoplay = true;
            remoteVideo.playsinline = true;
            
            videoContainer.appendChild(remoteVideo);
            videoGrid.appendChild(videoContainer);

            // Handle remote stream
            peerConnection.ontrack = (event) => {
                console.log('Received remote track');
                remoteVideo.srcObject = event.streams[0];
                
                // Try to play automatically, fallback to click-to-play
                remoteVideo.play().catch(() => {
                    console.log('Auto-play prevented for remote video, waiting for user interaction');
                });
            };

            // Handle ICE candidates
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        target: userId,
                        candidate: event.candidate
                    });
                }
            };

            // Log connection state changes
            peerConnection.onconnectionstatechange = () => {
                console.log(`Connection state with ${userId}:`, peerConnection.connectionState);
            };

            peers.set(userId, peerConnection);
            return peerConnection;
        }

        // Socket event handlers
        socket.on('user-connected', async (userId) => {
            console.log('User connected:', userId);
            participants.add(userId);
            updateRoomStatus();
            const peerConnection = await createPeerConnection(userId);
            
            // Create and send offer
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('offer', {
                target: userId,
                offer: offer
            });
        });

        socket.on('user-disconnected', (userId) => {
            console.log('User disconnected:', userId);
            participants.delete(userId);
            updateRoomStatus();
            const peerConnection = peers.get(userId);
            if (peerConnection) {
                peerConnection.close();
                peers.delete(userId);
            }
            const remoteVideo = document.getElementById(`remote-${userId}`);
            if (remoteVideo) {
                remoteVideo.parentElement.remove();
            }
        });

        // When joining a room, we should receive the list of existing participants
        socket.on('room-participants', (userIds) => {
            participants = new Set(userIds.filter(id => id !== socket.id));
            updateRoomStatus();
        });

        socket.on('offer', async ({ from, offer }) => {
            console.log('Received offer from:', from);
            const peerConnection = await createPeerConnection(from);
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            
            // Create and send answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', {
                target: from,
                answer: answer
            });
        });

        socket.on('answer', async ({ from, answer }) => {
            console.log('Received answer from:', from);
            const peerConnection = peers.get(from);
            if (peerConnection) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            }
        });

        socket.on('ice-candidate', async ({ from, candidate }) => {
            console.log('Received ICE candidate from:', from);
            const peerConnection = peers.get(from);
            if (peerConnection) {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            }
        });

        // Update room info and participants list
        function updateRoomInfo(roomId, participants) {
            roomInfo.innerText = `Room ID: ${roomId}`;
            participantsList.innerHTML = ''; // Clear existing list
            participants.forEach((participant) => {
                const li = document.createElement('li');
                li.innerText = participant;
                participantsList.appendChild(li);
            });
        }

        // Socket event for room data
        socket.on('room-data', ({ roomId, participants }) => {
            console.log('Room data received:', roomId, participants);
            updateRoomInfo(roomId, participants);
            statusArea.style.display = 'block'; // Show status area
        });

        // Auto-play will be handled by the browser now that we start with audio-only
    </script>
</body>
</html>